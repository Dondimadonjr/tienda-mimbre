<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Tienda de Mimbre</title>
  <style>
    :root{
      --bg:#FAF6F0;
      --card:#fff;
      --text:#1f2a24;
      --muted:#5b655f;
      --primary:#8B5E3C;
      --border:rgba(0,0,0,.12);
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    .container{ max-width:1100px; margin:auto; padding:24px 16px; }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      background:rgba(255,255,255,.7);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:999px;
    }
    .brand b{ font-size:14px; }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 0;
      font-size:18px;
    }
    .card .body{ padding:14px; }
    label{
      display:block;
      margin-bottom:10px;
      font-weight:700;
      font-size:13px;
    }
    input, textarea{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font:inherit;
    }
    textarea{ resize:vertical; min-height:90px; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .muted{ color:var(--muted); font-size:13px; }
    .list{
      display:grid;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns: 72px 1fr auto;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      align-items:center;
    }
    .thumb{
      width:72px; height:72px; border-radius:14px;
      background:#eee center/cover no-repeat;
      border:1px solid var(--border);
    }
    .item h3{ margin:0; font-size:15px; }
    .item .meta{ font-size:13px; color:var(--muted); margin-top:3px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }
    .ok{ color: #1a7f37; }
    .bad{ color: #b42318; }
    .hide{ display:none !important; }
    .divider{ height:1px; background:var(--border); margin:12px 0; }
    .hint{
      background:rgba(139,94,60,.08);
      border:1px solid rgba(139,94,60,.25);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="brand"><span aria-hidden="true">ðŸ§º</span> <b>Admin Â· ArtesanÃ­a en Mimbre</b></div>
      <div class="actions">
        <a class="btn" href="/" target="_blank" rel="noopener">Ver tienda</a>
        <button class="btn" id="logoutBtn" type="button">Cerrar sesiÃ³n</button>
      </div>
    </div>

    <div class="grid">
      <!-- LOGIN -->
      <div class="card" id="loginCard">
        <h2>Iniciar sesiÃ³n</h2>
        <div class="body">
          <p class="muted">Usa tu admin para gestionar productos.</p>
          <label>
            Email
            <input id="email" type="email" placeholder="admin@tienda.com" />
          </label>
          <label>
            ContraseÃ±a
            <input id="password" type="password" placeholder="admin1234" />
          </label>
          <button class="btn primary" id="loginBtn" type="button">Entrar</button>
          <div class="divider"></div>
          <p class="hint">
            Tip: al iniciar el servidor por primera vez, se crea un admin por defecto
            (<b>admin@tienda.com</b> / <b>admin1234</b>). Luego lo cambiamos.
          </p>
          <p id="loginMsg" class="muted"></p>
        </div>
      </div>

      <!-- CRUD -->
      <div class="card hide" id="crudCard">
        <h2>Productos</h2>
        <div class="body">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
            <span class="chip" id="statusChip">ðŸ”’ No autenticado</span>
            <button class="btn" id="refreshBtn" type="button">Recargar</button>
          </div>

          <div class="divider"></div>

          <h3 style="margin:0 0 10px;">Crear / Editar</h3>
          <input type="hidden" id="editId" />

          <label>
            Nombre
            <input id="pName" type="text" placeholder="Ej: Canasto de mimbre" />
          </label>

          <div class="row">
            <label>
              Precio (CLP, sin puntos)
              <input id="pPrice" type="number" inputmode="numeric" placeholder="12990" />
            </label>
            <label>
              Activo (1=SÃ­, 0=No)
              <input id="pActive" type="number" min="0" max="1" value="1" />
            </label>
          </div>

          <label>
            Imagen (URL o ruta local tipo image/canasto.webp)
            <input id="pImg" type="text" placeholder="image/canasto.webp" />
          </label>

          <label>
            DescripciÃ³n
            <textarea id="pDesc" placeholder="Describe el producto..."></textarea>
          </label>

          <div class="actions" style="justify-content:flex-start;">
            <button class="btn primary" id="saveBtn" type="button">Guardar</button>
            <button class="btn" id="clearBtn" type="button">Limpiar</button>
          </div>

          <div class="divider"></div>

          <h3 style="margin:0 0 10px;">Listado</h3>
          <div class="list" id="list"></div>
          <p id="msg" class="muted"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOKEN_KEY = "admin_token_v1";

    const $ = (q) => document.querySelector(q);
    const fmtCLP = (n) => Number(n || 0).toLocaleString("es-CL", { style:"currency", currency:"CLP" });

    const loginCard = $("#loginCard");
    const crudCard = $("#crudCard");
    const loginMsg = $("#loginMsg");
    const statusChip = $("#statusChip");

    const email = $("#email");
    const password = $("#password");
    const loginBtn = $("#loginBtn");
    const logoutBtn = $("#logoutBtn");
    const refreshBtn = $("#refreshBtn");

    const editId = $("#editId");
    const pName = $("#pName");
    const pPrice = $("#pPrice");
    const pImg = $("#pImg");
    const pDesc = $("#pDesc");
    const pActive = $("#pActive");

    const saveBtn = $("#saveBtn");
    const clearBtn = $("#clearBtn");
    const list = $("#list");
    const msg = $("#msg");

    function getToken(){
      return localStorage.getItem(TOKEN_KEY);
    }
    function setToken(t){
      localStorage.setItem(TOKEN_KEY, t);
    }
    function clearToken(){
      localStorage.removeItem(TOKEN_KEY);
    }

    function showAuthed(){
      loginCard.classList.add("hide");
      crudCard.classList.remove("hide");
      statusChip.textContent = "ðŸŸ¢ Autenticado";
      statusChip.classList.add("ok");
    }

    function showLogin(){
      loginCard.classList.remove("hide");
      crudCard.classList.add("hide");
      statusChip.textContent = "ðŸ”’ No autenticado";
      statusChip.classList.remove("ok");
    }

    async function api(path, opts = {}){
      const token = getToken();
      const headers = Object.assign(
        { "Content-Type":"application/json" },
        opts.headers || {}
      );

      if(token) headers.Authorization = "Bearer " + token;

      const res = await fetch(path, { ...opts, headers });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(data.error || "Error API");
      return data;
    }

    async function login(){
      loginMsg.textContent = "";
      try{
        const data = await api("/api/admin/login", {
          method:"POST",
          body: JSON.stringify({ email: email.value.trim(), password: password.value })
        });
        setToken(data.token);
        showAuthed();
        await loadProducts();
      }catch(e){
        loginMsg.textContent = "âŒ " + e.message;
      }
    }

    function clearForm(){
      editId.value = "";
      pName.value = "";
      pPrice.value = "";
      pImg.value = "";
      pDesc.value = "";
      pActive.value = "1";
      msg.textContent = "";
    }

    function fillForm(p){
      editId.value = p.id;
      pName.value = p.name;
      pPrice.value = p.price;
      pImg.value = p.img;
      pDesc.value = p.desc;
      pActive.value = p.active;
      msg.textContent = "Editando ID " + p.id;
    }

    async function loadProducts(){
      msg.textContent = "Cargando...";
      try{
        const products = await api("/api/admin/products");
        list.innerHTML = products.map(p => `
          <div class="item">
            <div class="thumb" style="background-image:url('${p.img}')"></div>
            <div>
              <h3>${p.name}</h3>
              <div class="meta">${fmtCLP(p.price)} Â· ID ${p.id} Â· ${p.active ? "Activo" : "Inactivo"}</div>
              <div class="meta">${p.desc}</div>
            </div>
            <div class="actions">
              <button class="btn" data-edit="${p.id}">Editar</button>
              <button class="btn" data-del="${p.id}">Borrar</button>
            </div>
          </div>
        `).join("");

        msg.textContent = products.length ? "" : "No hay productos aÃºn. Crea el primero ðŸ™‚";
        // Guardar lista para editar rÃ¡pido
        window.__products = products;
      }catch(e){
        msg.textContent = "âŒ " + e.message;
      }
    }

    async function save(){
      msg.textContent = "";
      const body = {
        name: pName.value.trim(),
        price: Number(pPrice.value),
        img: pImg.value.trim(),
        desc: pDesc.value.trim(),
        active: Number(pActive.value) ? 1 : 0
      };

      if(!body.name || !body.price || !body.img || !body.desc){
        msg.textContent = "â— Completa nombre, precio, imagen y descripciÃ³n";
        return;
      }

      try{
        if(editId.value){
          await api("/api/admin/products/" + editId.value, {
            method:"PUT",
            body: JSON.stringify(body)
          });
          msg.textContent = "âœ… Producto actualizado";
        }else{
          await api("/api/admin/products", {
            method:"POST",
            body: JSON.stringify(body)
          });
          msg.textContent = "âœ… Producto creado";
        }
        clearForm();
        await loadProducts();
      }catch(e){
        msg.textContent = "âŒ " + e.message;
      }
    }

    async function del(id){
      if(!confirm("Â¿Borrar producto ID " + id + "?")) return;
      try{
        await api("/api/admin/products/" + id, { method:"DELETE" });
        msg.textContent = "âœ… Producto borrado";
        await loadProducts();
      }catch(e){
        msg.textContent = "âŒ " + e.message;
      }
    }

    // Events
    loginBtn.addEventListener("click", login);
    logoutBtn.addEventListener("click", ()=>{
      clearToken();
      clearForm();
      showLogin();
    });
    refreshBtn.addEventListener("click", loadProducts);
    saveBtn.addEventListener("click", save);
    clearBtn.addEventListener("click", clearForm);

    list.addEventListener("click", (e)=>{
      const edit = e.target.closest("[data-edit]")?.dataset.edit;
      const delId = e.target.closest("[data-del]")?.dataset.del;

      if(edit){
        const p = (window.__products || []).find(x => String(x.id) === String(edit));
        if(p) fillForm(p);
      }
      if(delId){
        del(delId);
      }
    });

    // Auto init
    (async function init(){
      const token = getToken();
      if(token){
        showAuthed();
        await loadProducts();
      }else{
        showLogin();
      }
    })();
  </script>
</body>
</html>
